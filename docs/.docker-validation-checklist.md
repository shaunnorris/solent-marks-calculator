# Docker Setup Validation Checklist

This checklist helps verify the Docker deployment is configured correctly.

## Pre-deployment Validation

### ‚úÖ Files Created
- [x] Dockerfile
- [x] docker-compose.yml
- [x] .dockerignore
- [x] nginx-docker.conf
- [x] gunicorn-docker.conf.py
- [x] DOCKER_DEPLOYMENT.md
- [x] Makefile
- [x] docker-quick-start.sh
- [x] .github/workflows/docker-build.yml
- [x] DEPLOYMENT_SUMMARY.md

### ‚úÖ Syntax Validation
- [x] docker-compose.yml - Valid YAML
- [x] gunicorn-docker.conf.py - Valid Python
- [x] Dockerfile - Proper syntax
- [x] nginx-docker.conf - Valid Nginx config
- [x] Makefile - Proper format

### üìã Pre-deployment Tests

Run these commands to validate before deploying:

```bash
# 1. Check Docker installation
command -v docker && echo "‚úÖ Docker installed" || echo "‚ùå Docker missing"

# 2. Check Docker Compose installation
command -v docker-compose && echo "‚úÖ Docker Compose installed" || echo "‚ùå Docker Compose missing"

# 3. Validate YAML syntax
python3 -c "import yaml; yaml.safe_load(open('docker-compose.yml'))" && echo "‚úÖ docker-compose.yml valid"

# 4. Validate Python syntax
python3 -c "compile(open('gunicorn-docker.conf.py').read(), 'gunicorn-docker.conf.py', 'exec')" && echo "‚úÖ Gunicorn config valid"

# 5. Check required files exist
test -f 2025scra.gpx && echo "‚úÖ GPX file exists" || echo "‚ùå GPX file missing"
test -f app.py && echo "‚úÖ app.py exists" || echo "‚ùå app.py missing"
test -d templates && echo "‚úÖ templates directory exists" || echo "‚ùå templates missing"

# 6. Build Docker image (dry run)
docker build -t solent-marks-test . && echo "‚úÖ Docker build successful"

# 7. Test docker-compose config
docker-compose config && echo "‚úÖ Docker Compose config valid"
```

## Deployment Validation

After running `docker-compose up -d`:

### Container Health
```bash
# 1. Check containers are running
docker-compose ps

# Expected: Both containers in "Up" state

# 2. Check health status
docker inspect --format='{{json .State.Health}}' solent-marks-calculator
docker inspect --format='{{json .State.Health}}' solent-marks-nginx

# Expected: "Status": "healthy"
```

### Network Connectivity
```bash
# 1. Test Nginx health endpoint
curl -f http://localhost/health && echo "‚úÖ Nginx health OK" || echo "‚ùå Nginx health FAILED"

# 2. Test application direct access
curl -f http://localhost:8000/ && echo "‚úÖ App direct access OK" || echo "‚ùå App direct FAILED"

# 3. Test application via Nginx
curl -f http://localhost/ && echo "‚úÖ App via Nginx OK" || echo "‚ùå App via Nginx FAILED"

# 4. Test application endpoints
curl -s http://localhost/marks | jq '.marks | length' && echo "‚úÖ API working"
```

### Logs Check
```bash
# 1. Check for errors in web container
docker-compose logs web | grep -i error && echo "‚ö†Ô∏è Errors found in web logs" || echo "‚úÖ No errors in web logs"

# 2. Check for errors in nginx container
docker-compose logs nginx | grep -i error && echo "‚ö†Ô∏è Errors found in nginx logs" || echo "‚úÖ No errors in nginx logs"

# 3. Watch live logs
docker-compose logs -f --tail=50
```

### Resource Usage
```bash
# Check memory and CPU usage
docker stats --no-stream solent-marks-calculator solent-marks-nginx

# Expected:
# - Web container: < 200MB RAM
# - Nginx container: < 50MB RAM
# - Both: < 5% CPU when idle
```

## Production Readiness

### Security Checklist
- [ ] Update nginx-docker.conf with production domain
- [ ] Configure SSL/TLS certificates
- [ ] Uncomment HTTPS server block in nginx-docker.conf
- [ ] Mount SSL certificates in docker-compose.yml
- [ ] Set proper environment variables
- [ ] Review security headers in Nginx config
- [ ] Enable Docker security scanning
- [ ] Review container resource limits
- [ ] Ensure no secrets in environment variables (use Docker secrets)
- [ ] Verify containers run as non-root user

### Performance Checklist
- [ ] Adjust Gunicorn workers based on CPU cores
- [ ] Configure resource limits in docker-compose.yml
- [ ] Enable nginx caching if needed
- [ ] Set up log rotation
- [ ] Configure keepalive timeouts
- [ ] Test under load
- [ ] Monitor response times

### Monitoring Checklist
- [ ] Health checks configured
- [ ] Logs aggregation set up (optional)
- [ ] Metrics collection configured (optional)
- [ ] Alerting configured (optional)
- [ ] Uptime monitoring (optional)
- [ ] Error tracking (optional)

### Backup Checklist
- [ ] GPX data backup strategy
- [ ] Docker image backup/registry
- [ ] Configuration backup
- [ ] Document recovery procedure
- [ ] Test restore procedure

### CI/CD Checklist
- [ ] GitHub Actions workflow configured
- [ ] Docker Hub credentials added (if publishing)
- [ ] Security scanning enabled
- [ ] Automated testing enabled
- [ ] Deployment triggers configured

## Post-deployment Verification

Run these tests after deploying to production:

```bash
# 1. Full application test
curl -X GET "http://your-domain.com/marks?zones=1,2" | jq .

# 2. Calculate endpoint test
curl -X POST "http://your-domain.com/calculate" \
  -H "Content-Type: application/json" \
  -d '{"mark1":"1A","mark2":"1B"}' | jq .

# 3. Course endpoint test
curl -X POST "http://your-domain.com/course" \
  -H "Content-Type: application/json" \
  -d '{"course":["1A","1B","2C"]}' | jq .

# 4. SSL/TLS test (if configured)
curl -I https://your-domain.com | grep "HTTP/2 200"

# 5. Security headers test
curl -I http://your-domain.com | grep -E "(X-Frame-Options|X-XSS-Protection|X-Content-Type-Options)"

# 6. Load test (optional - adjust parameters)
ab -n 1000 -c 10 http://your-domain.com/health
```

## Rollback Plan

If deployment fails:

```bash
# 1. Stop new deployment
docker-compose down

# 2. Restore previous version (if using tags)
docker-compose pull solent-marks-calculator:previous
docker-compose up -d

# 3. Or revert to systemd (if migrating)
sudo systemctl start solent-marks
sudo systemctl enable solent-marks
```

## Troubleshooting

Common issues and solutions:

### Container won't start
```bash
# Check logs
docker-compose logs web

# Common fixes:
# - Port conflict: Change port in docker-compose.yml
# - Permission error: Check file ownership
# - Missing files: Verify .dockerignore
```

### Cannot connect to application
```bash
# Check firewall
sudo ufw status
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp

# Check if ports are listening
netstat -tlnp | grep -E ':(80|443|8000)'

# Check Docker network
docker network inspect solent-marks-calculator_app-network
```

### Performance issues
```bash
# Check resource usage
docker stats

# Increase workers (edit gunicorn-docker.conf.py)
workers = 4  # or more

# Restart
docker-compose restart web
```

### SSL certificate issues
```bash
# Verify certificate files
ls -la /etc/letsencrypt/live/your-domain/

# Test Nginx config
docker-compose exec nginx nginx -t

# Reload Nginx
docker-compose restart nginx
```

## Success Criteria

Deployment is successful when:

- [x] All containers show "Up (healthy)" status
- [x] Application accessible via http://localhost
- [x] Health endpoints return 200 OK
- [x] API endpoints return valid JSON
- [x] No errors in container logs
- [x] Resource usage within acceptable limits
- [x] Response times < 200ms for health checks

## Sign-off

- [ ] All validation tests passed
- [ ] Production checklist completed
- [ ] Post-deployment verification successful
- [ ] Monitoring configured
- [ ] Team trained on new deployment
- [ ] Documentation updated
- [ ] Rollback plan tested

Validated by: ________________  
Date: ________________  

